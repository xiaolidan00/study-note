<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>æµ·åº·è§†é¢‘é¢„è§ˆ</title>
  </head>
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
    }
    .playWnd {
      margin: 30px 0 0 400px;
      width: 1000px; /*æ’­æ”¾å®¹å™¨çš„å®½å’Œé«˜è®¾å®š*/
      height: 600px;
      border: 1px solid red;
    }
    .operate {
      margin-top: 24px;
    }
    .operate::after {
      content: '';
      display: block;
      clear: both;
    }
    .module {
      float: left;
      width: 340px;
      /*min-height: 320px;*/
      margin-left: 16px;
      padding: 16px 8px;
      box-sizing: border-box;
      border: 1px solid #e5e5e5;
    }
    .module .item {
      margin-bottom: 4px;
    }
    .module input[type='text'] {
      box-sizing: border-box;
      display: inline-block;
      vertical-align: middle;
      margin-left: 0;
      width: 150px;
      min-height: 20px;
    }
    .module .btn {
      min-width: 80px;
      min-height: 24px;
      margin-top: 100px;
      margin-left: 80px;
    }
  </style>

  <body>
    <!--é¢„è§ˆç•Œé¢-->
    <div id="operate" class="operate">
      <div class="module">
        <div class="item">
          <span class="label">ç›‘æ§ç‚¹ç¼–å·ï¼š</span
          ><input
            id="cameraIndexCode"
            value="d21fe9e6188644f38a62cd376e000666"
            type="text"
            value=""
          />
        </div>
        <div class="item" style="margin-top: 20px; margin-left: -20px">
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <button style="width: 20px; padding: 0; margin: 0" id="startPreview" class="btn">
            é¢„è§ˆ
          </button>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <button style="width: 90px; padding: 0; margin: 0" id="stopAllPreview" class="btn">
            åœæ­¢å…¨éƒ¨é¢„è§ˆ
          </button>
          <button id="snap">snap</button>
        </div>
      </div>
    </div>
    <!--è§†é¢‘çª—å£å±•ç¤º-->
    <div id="playWnd" class="playWnd" style="left: 109px; top: 133px"></div>
  </body>

  <!--ä¸‰ä¸ªå¿…è¦çš„jsæ–‡ä»¶å¼•å…¥-->
  <script src="jquery-1.12.4.min.js"></script>
  <script src="jsencrypt.min.js"></script>
  <!-- ç”¨äºRSAåŠ å¯† -->
  <script src="web-control_1.2.7.min.js"></script>
  <!-- ç”¨äºå‰ç«¯ä¸æ’ä»¶äº¤äº’ -->

  <script type="text/javascript">
    //é¡µé¢åŠ è½½æ—¶åˆ›å»ºæ’­æ”¾å®ä¾‹åˆå§‹åŒ–
    $(window).load(function () {
      initPlugin();
    });

    //å£°æ˜å…¬ç”¨å˜é‡
    var initCount = 0;
    var pubKey = '';

    // åˆ›å»ºæ’­æ”¾å®ä¾‹
    function initPlugin() {
      oWebControl = new WebControl({
        szPluginContainer: 'playWnd', // æŒ‡å®šå®¹å™¨id
        iServicePortStart: 15900, // æŒ‡å®šèµ·æ­¢ç«¯å£å·ï¼Œå»ºè®®ä½¿ç”¨è¯¥å€¼
        iServicePortEnd: 15900,
        szClassId: '23BF3B0A-2C56-4D97-9C03-0CB103AA8F11', // ç”¨äºIE10ä½¿ç”¨ActiveXçš„clsid
        cbConnectSuccess: function () {
          // åˆ›å»ºWebControlå®ä¾‹æˆåŠŸ
          oWebControl
            .JS_StartService('window', {
              // WebControlå®ä¾‹åˆ›å»ºæˆåŠŸåéœ€è¦å¯åŠ¨æœåŠ¡
              dllPath: './VideoPluginConnect.dll' // å€¼"./VideoPluginConnect.dll"å†™æ­»
            })
            .then(
              function () {
                // å¯åŠ¨æ’ä»¶æœåŠ¡æˆåŠŸ
                oWebControl.JS_SetWindowControlCallback({
                  // è®¾ç½®æ¶ˆæ¯å›è°ƒ
                  cbIntegrationCallBack: cbIntegrationCallBack
                });

                oWebControl.JS_CreateWnd('playWnd', 1000, 600).then(function () {
                  //JS_CreateWndåˆ›å»ºè§†é¢‘æ’­æ”¾çª—å£ï¼Œå®½é«˜å¯è®¾å®š
                  init(); // åˆ›å»ºæ’­æ”¾å®ä¾‹æˆåŠŸååˆå§‹åŒ–
                });
              },
              function () {
                // å¯åŠ¨æ’ä»¶æœåŠ¡å¤±è´¥
              }
            );
        },
        cbConnectError: function () {
          // åˆ›å»ºWebControlå®ä¾‹å¤±è´¥
          oWebControl = null;
          $('#playWnd').html('æ’ä»¶æœªå¯åŠ¨ï¼Œæ­£åœ¨å°è¯•å¯åŠ¨ï¼Œè¯·ç¨å€™...');
          WebControl.JS_WakeUp('VideoWebPlugin://'); // ç¨‹åºæœªå¯åŠ¨æ—¶æ‰§è¡Œerrorå‡½æ•°ï¼Œé‡‡ç”¨wakeupæ¥å¯åŠ¨ç¨‹åº
          initCount++;
          if (initCount < 3) {
            setTimeout(function () {
              initPlugin();
            }, 3000);
          } else {
            $('#playWnd').html('æ’ä»¶å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ’ä»¶æ˜¯å¦å®‰è£…ï¼');
          }
        },
        cbConnectClose: function (bNormalClose) {
          // å¼‚å¸¸æ–­å¼€ï¼šbNormalClose = false
          // JS_Disconnectæ­£å¸¸æ–­å¼€ï¼šbNormalClose = true
          console.log('cbConnectClose');
          oWebControl = null;
          $('#playWnd').html('æ’ä»¶æœªå¯åŠ¨ï¼Œæ­£åœ¨å°è¯•å¯åŠ¨ï¼Œè¯·ç¨å€™...');
          WebControl.JS_WakeUp('VideoWebPlugin://');
          initCount++;
          if (initCount < 3) {
            setTimeout(function () {
              initPlugin();
            }, 3000);
          } else {
            $('#playWnd').html('æ’ä»¶å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ’ä»¶æ˜¯å¦å®‰è£…ï¼');
          }
        }
      });
    }

    // è®¾ç½®çª—å£æ§åˆ¶å›è°ƒ
    function setCallbacks() {
      oWebControl.JS_SetWindowControlCallback({
        cbIntegrationCallBack: cbIntegrationCallBack
      });
    }

    function showCBInfo(res) {
      if (res.type == 3) {
        console.log('ğŸš€ ~ demo_window_simple_preview.html ~ showCBInfo ~ res:', res);
      }
      //   console.log("ğŸš€ ~ demo_window_simple_preview.html ~ showCBInfo ~ msg:", msg);
    }
    // æ¨é€æ¶ˆæ¯
    function cbIntegrationCallBack(oData) {
      showCBInfo(oData.responseMsg);
    }

    //åˆå§‹åŒ–
    function init() {
      getPubKey(function () {
        ////////////////////////////////// è¯·è‡ªè¡Œä¿®æ”¹ä»¥ä¸‹å˜é‡å€¼	////////////////////////////////////
        var appkey = '25317070'; //ç»¼åˆå®‰é˜²ç®¡ç†å¹³å°æä¾›çš„appkeyï¼Œå¿…å¡«
        var secret = setEncrypt('9IR7uDe6xCVWCMuI8LmZ'); //ç»¼åˆå®‰é˜²ç®¡ç†å¹³å°æä¾›çš„secretï¼Œå¿…å¡«
        var ip = '10.200.6.99'; //ç»¼åˆå®‰é˜²ç®¡ç†å¹³å°IPåœ°å€ï¼Œå¿…å¡«
        var playMode = 0; //åˆå§‹æ’­æ”¾æ¨¡å¼ï¼š0-é¢„è§ˆï¼Œ1-å›æ”¾
        var port = 443; //ç»¼åˆå®‰é˜²ç®¡ç†å¹³å°ç«¯å£ï¼Œè‹¥å¯ç”¨HTTPSåè®®ï¼Œé»˜è®¤443
        var snapDir = 'D:\\SnapDir'; //æŠ“å›¾å­˜å‚¨è·¯å¾„
        var videoDir = 'D:\\VideoDir'; //ç´§æ€¥å½•åƒæˆ–å½•åƒå‰ªè¾‘å­˜å‚¨è·¯å¾„
        var layout = '1x1'; //playModeæŒ‡å®šæ¨¡å¼çš„å¸ƒå±€
        var enableHTTPS = 1; //æ˜¯å¦å¯ç”¨HTTPSåè®®ä¸ç»¼åˆå®‰é˜²ç®¡ç†å¹³å°äº¤äº’ï¼Œè¿™é‡Œæ€»æ˜¯å¡«1
        var encryptedFields = 'secret'; //åŠ å¯†å­—æ®µï¼Œé»˜è®¤åŠ å¯†é¢†åŸŸä¸ºsecret
        var showToolbar = 1; //æ˜¯å¦æ˜¾ç¤ºå·¥å…·æ ï¼Œ0-ä¸æ˜¾ç¤ºï¼Œé0-æ˜¾ç¤º
        var showSmart = 1; //æ˜¯å¦æ˜¾ç¤ºæ™ºèƒ½ä¿¡æ¯ï¼ˆå¦‚é…ç½®ç§»åŠ¨ä¾¦æµ‹åç”»é¢ä¸Šçš„çº¿æ¡†ï¼‰ï¼Œ0-ä¸æ˜¾ç¤ºï¼Œé0-æ˜¾ç¤º
        var buttonIDs = '0,16,256,257,258,259,260,512,513,514,515,516,517,768,769'; //è‡ªå®šä¹‰å·¥å…·æ¡æŒ‰é’®
        ////////////////////////////////// è¯·è‡ªè¡Œä¿®æ”¹ä»¥ä¸Šå˜é‡å€¼	////////////////////////////////////

        oWebControl
          .JS_RequestInterface({
            funcName: 'init',
            argument: JSON.stringify({
              appkey: appkey, //APIç½‘å…³æä¾›çš„appkey
              secret: secret, //APIç½‘å…³æä¾›çš„secret
              ip: ip, //APIç½‘å…³IPåœ°å€
              playMode: playMode, //æ’­æ”¾æ¨¡å¼ï¼ˆå†³å®šæ˜¾ç¤ºé¢„è§ˆè¿˜æ˜¯å›æ”¾ç•Œé¢ï¼‰
              port: port, //ç«¯å£
              snapDir: snapDir, //æŠ“å›¾å­˜å‚¨è·¯å¾„
              videoDir: videoDir, //ç´§æ€¥å½•åƒæˆ–å½•åƒå‰ªè¾‘å­˜å‚¨è·¯å¾„
              layout: layout, //å¸ƒå±€
              enableHTTPS: enableHTTPS, //æ˜¯å¦å¯ç”¨HTTPSåè®®
              encryptedFields: encryptedFields, //åŠ å¯†å­—æ®µ
              showToolbar: showToolbar, //æ˜¯å¦æ˜¾ç¤ºå·¥å…·æ 
              showSmart: showSmart, //æ˜¯å¦æ˜¾ç¤ºæ™ºèƒ½ä¿¡æ¯
              buttonIDs: buttonIDs //è‡ªå®šä¹‰å·¥å…·æ¡æŒ‰é’®
            })
          })
          .then(function (oData) {
            oWebControl.JS_Resize(1000, 600); // åˆå§‹åŒ–åresizeä¸€æ¬¡ï¼Œè§„é¿firefoxä¸‹é¦–æ¬¡æ˜¾ç¤ºçª—å£åæ’ä»¶çª—å£æœªä¸DIVçª—å£é‡åˆé—®é¢˜
          });
      });
    }

    //è·å–å…¬é’¥
    function getPubKey(callback) {
      oWebControl
        .JS_RequestInterface({
          funcName: 'getRSAPubKey',
          argument: JSON.stringify({
            keyLength: 1024
          })
        })
        .then(function (oData) {
          console.log(oData);
          if (oData.responseMsg.data) {
            pubKey = oData.responseMsg.data;
            callback();
          }
        });
    }

    //RSAåŠ å¯†
    function setEncrypt(value) {
      var encrypt = new JSEncrypt();
      encrypt.setPublicKey(pubKey);
      return encrypt.encrypt(value);
    }

    // ç›‘å¬resizeäº‹ä»¶ï¼Œä½¿æ’ä»¶çª—å£å°ºå¯¸è·ŸéšDIVçª—å£å˜åŒ–
    $(window).resize(function () {
      if (oWebControl != null) {
        oWebControl.JS_Resize(1000, 600);
        setWndCover();
      }
    });

    // ç›‘å¬æ»šåŠ¨æ¡scrolläº‹ä»¶ï¼Œä½¿æ’ä»¶çª—å£è·Ÿéšæµè§ˆå™¨æ»šåŠ¨è€Œç§»åŠ¨
    $(window).scroll(function () {
      if (oWebControl != null) {
        oWebControl.JS_Resize(1000, 600);
        setWndCover();
      }
    });

    // è®¾ç½®çª—å£è£å‰ªï¼Œå½“å› æ»šåŠ¨æ¡æ»šåŠ¨å¯¼è‡´çª—å£éœ€è¦è¢«é®ä½çš„æƒ…å†µä¸‹éœ€è¦JS_CuttingPartWindowéƒ¨åˆ†çª—å£
    function setWndCover() {
      var iWidth = $(window).width();
      var iHeight = $(window).height();
      var oDivRect = $('#playWnd').get(0).getBoundingClientRect();

      var iCoverLeft = oDivRect.left < 0 ? Math.abs(oDivRect.left) : 0;
      var iCoverTop = oDivRect.top < 0 ? Math.abs(oDivRect.top) : 0;
      var iCoverRight = oDivRect.right - iWidth > 0 ? Math.round(oDivRect.right - iWidth) : 0;
      var iCoverBottom = oDivRect.bottom - iHeight > 0 ? Math.round(oDivRect.bottom - iHeight) : 0;

      iCoverLeft = iCoverLeft > 1000 ? 1000 : iCoverLeft;
      iCoverTop = iCoverTop > 600 ? 600 : iCoverTop;
      iCoverRight = iCoverRight > 1000 ? 1000 : iCoverRight;
      iCoverBottom = iCoverBottom > 600 ? 600 : iCoverBottom;

      oWebControl.JS_RepairPartWindow(0, 0, 1001, 600); // å¤š1ä¸ªåƒç´ ç‚¹é˜²æ­¢è¿˜åŸåè¾¹ç•Œç¼ºå¤±ä¸€ä¸ªåƒç´ æ¡
      if (iCoverLeft != 0) {
        oWebControl.JS_CuttingPartWindow(0, 0, iCoverLeft, 600);
      }
      if (iCoverTop != 0) {
        oWebControl.JS_CuttingPartWindow(0, 0, 1001, iCoverTop); // å¤šå‰ªæ‰ä¸€ä¸ªåƒç´ æ¡ï¼Œé˜²æ­¢å‡ºç°å‰ªæ‰ä¸€éƒ¨åˆ†çª—å£åå‡ºç°ä¸€ä¸ªåƒç´ æ¡
      }
      if (iCoverRight != 0) {
        oWebControl.JS_CuttingPartWindow(1000 - iCoverRight, 0, iCoverRight, 600);
      }
      if (iCoverBottom != 0) {
        oWebControl.JS_CuttingPartWindow(0, 600 - iCoverBottom, 1000, iCoverBottom);
      }
    }

    //è§†é¢‘é¢„è§ˆåŠŸèƒ½
    $('#startPreview').click(function () {
      var cameraIndexCode = $('#cameraIndexCode').val(); //è·å–è¾“å…¥çš„ç›‘æ§ç‚¹ç¼–å·å€¼ï¼Œå¿…å¡«
      var streamMode = 0; //ä¸»å­ç æµæ ‡è¯†ï¼š0-ä¸»ç æµï¼Œ1-å­ç æµ
      var transMode = 1; //ä¼ è¾“åè®®ï¼š0-UDPï¼Œ1-TCP
      var gpuMode = 0; //æ˜¯å¦å¯ç”¨GPUç¡¬è§£ï¼Œ0-ä¸å¯ç”¨ï¼Œ1-å¯ç”¨
      var wndId = -1; //æ’­æ”¾çª—å£åºå·ï¼ˆåœ¨2x2ä»¥ä¸Šå¸ƒå±€ä¸‹å¯æŒ‡å®šæ’­æ”¾çª—å£ï¼‰

      cameraIndexCode = cameraIndexCode.replace(/(^\s*)/g, '');
      cameraIndexCode = cameraIndexCode.replace(/(\s*$)/g, '');

      oWebControl.JS_RequestInterface({
        funcName: 'startPreview',
        argument: JSON.stringify({
          cameraIndexCode: cameraIndexCode, //ç›‘æ§ç‚¹ç¼–å·
          streamMode: streamMode, //ä¸»å­ç æµæ ‡è¯†
          transMode: transMode, //ä¼ è¾“åè®®
          gpuMode: gpuMode, //æ˜¯å¦å¼€å¯GPUç¡¬è§£
          wndId: wndId //å¯æŒ‡å®šæ’­æ”¾çª—å£
        }),
        success: function (ev) {
          console.log('ğŸš€ ~ demo_window_simple_preview.html ~ ev:', ev);
        },
        error: function (oError) {}
      });
    });
    document.getElementById('snap').onclick = () => {
      oWebControl
        .JS_RequestInterface({
          funcName: 'snapShot',
          argument: JSON.stringify({name: 'D:\test.jpg'})
        })
        .then((res) => {
          console.log('ğŸš€ ~ demo_window_simple_preview.html ~ .then ~ res:', res);
        });
    };

    //åœæ­¢å…¨éƒ¨é¢„è§ˆ
    $('#stopAllPreview').click(function () {
      oWebControl.JS_RequestInterface({
        funcName: 'stopAllPreview'
      });
    });

    // æ ‡ç­¾å…³é—­
    $(window).unload(function () {
      if (oWebControl != null) {
        oWebControl.JS_HideWnd(); // å…ˆè®©çª—å£éšè—ï¼Œè§„é¿å¯èƒ½çš„æ’ä»¶çª—å£æ»åäºæµè§ˆå™¨æ¶ˆå¤±é—®é¢˜
        oWebControl.JS_Disconnect().then(
          function () {
            // æ–­å¼€ä¸æ’ä»¶æœåŠ¡è¿æ¥æˆåŠŸ
          },
          function () {
            // æ–­å¼€ä¸æ’ä»¶æœåŠ¡è¿æ¥å¤±è´¥
          }
        );
      }
    });
  </script>
</html>
